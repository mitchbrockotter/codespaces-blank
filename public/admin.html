<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - P&K Backend Automation</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar dashboard-navbar">
        <div class="navbar-container">
            <div class="navbar-left">
                <a href="/admin" class="navbar-brand">
                    <img src="/images/logo.png" alt="P&K Backend Automation Logo" class="navbar-logo">
                    <span>Admin Panel</span>
                </a>
            </div>
            <div class="navbar-right">
                <span id="userDisplay" class="user-display"></span>
                <button id="logoutBtn" class="btn btn-small">Logout</button>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <aside class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="/dashboard" class="menu-item">Dashboard</a></li>
                <li><a href="/admin" class="menu-item active">User Management</a></li>
                <li><a href="#environments" class="menu-item" onclick="document.getElementById('environments').scrollIntoView({behavior: 'smooth'}); return false;">Environments</a></li>
                <li><a href="#activities" class="menu-item">Activity Log</a></li>
                <li><a href="/environment" class="menu-item">My Environment</a></li>
            </ul>
        </aside>

        <main class="dashboard-content">
            <div class="content-header">
                <h1>Admin Control Panel</h1>
                <p>Manage users, permissions, and system configuration</p>
            </div>

            <!-- System Statistics -->
            <div class="admin-section">
                <h2>System Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsers">-</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUsers">-</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalEnvironments">-</div>
                        <div class="stat-label">Environments</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="serverStatus">-</div>
                        <div class="stat-label">Server Status</div>
                    </div>
                </div>
            </div>

            <!-- User Management Section -->
            <div class="admin-section">
                <h2>User Management</h2>
                
                <div class="admin-controls">
                    <input type="text" id="userSearch" placeholder="Search users..." class="search-input">
                    <button id="addUserBtn" class="btn btn-primary">+ Add New User</button>
                </div>

                <div id="usersTable" class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Company</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Redirect</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="8" class="loading">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Activity Log Section -->
            <div class="admin-section" id="activities">
                <h2>Recent Activity Log</h2>
                
                <div class="activity-section">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="activityTableBody">
                            <tr>
                                <td colspan="4" class="loading">Loading activity log...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Environment Management Section -->
            <div class="admin-section" id="environments">
                <h2>Environment Management</h2>
                <p style="color: var(--text-light); margin-bottom: 1.5rem;">Beheer gebruikersomgevingen voor het uploaden van tools en automatiseringen</p>
                
                <div class="admin-controls">
                    <input type="text" id="envSearch" placeholder="Zoek omgevingen..." class="search-input">
                    <button id="addEnvBtn" class="btn btn-primary">+ Nieuwe Omgeving</button>
                </div>

                <div id="environmentsTable" class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Omgeving ID</th>
                                <th>Gebruiker</th>
                                <th>Bedrijf</th>
                                <th>Status</th>
                                <th>Tools</th>
                                <th>Aangemaakt</th>
                                <th>Acties</th>
                            </tr>
                        </thead>
                        <tbody id="environmentsTableBody">
                            <tr>
                                <td colspan="7" class="loading">Omgevingen laden...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Environment Modal -->
    <div id="addEnvModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" id="addEnvClose">&times;</span>
            <h2>Nieuwe Omgeving Aanmaken</h2>
            <form id="addEnvForm" class="form">
                <div class="form-group">
                    <label for="envUserId">Selecteer Gebruiker</label>
                    <select id="envUserId" required>
                        <option value="">-- Selecteer een gebruiker --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="envName">Omgeving Naam</label>
                    <input type="text" id="envName" placeholder="bijv: Production, Development" required>
                </div>
                <div class="form-group">
                    <label for="envDescription">Beschrijving</label>
                    <textarea id="envDescription" rows="3" placeholder="Omschrijf het doel van deze omgeving"></textarea>
                </div>
                <div class="form-group">
                    <label for="envStatus">Status</label>
                    <select id="envStatus">
                        <option value="active">Actief</option>
                        <option value="maintenance">Onderhoud</option>
                        <option value="inactive">Inactief</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary btn-block">Omgeving Aanmaken</button>
            </form>
        </div>
    </div>

    <!-- Edit Environment Modal -->
    <div id="editEnvModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" id="editEnvClose">&times;</span>
            <h2>Omgeving Bewerken</h2>
            <form id="editEnvForm" class="form">
                <input type="hidden" id="editEnvId">
                
                <div class="form-group">
                    <label for="editEnvName">Omgeving Naam</label>
                    <input type="text" id="editEnvName" required>
                </div>
                <div class="form-group">
                    <label for="editEnvDescription">Beschrijving</label>
                    <textarea id="editEnvDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editEnvStatus">Status</label>
                    <select id="editEnvStatus">
                        <option value="active">Actief</option>
                        <option value="maintenance">Onderhoud</option>
                        <option value="inactive">Inactief</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ge√Ønstalleerde Tools</label>
                    <div id="envToolsList" style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 6px; min-height: 100px;">
                        <p style="color: var(--text-light); font-size: 0.9rem;">Geen tools ge√Ønstalleerd</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>IntelliJ Projecten</label>
                    <div id="envProjectsList" style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 6px; min-height: 100px; margin-bottom: 1rem;">
                        <p style="color: var(--text-light); font-size: 0.9rem;">Geen IntelliJ projecten ge√ºpload</p>
                    </div>
                    <div style="border: 2px dashed rgba(0,212,255,0.3); border-radius: 6px; padding: 1rem; background: rgba(0,212,255,0.05);">
                        <h4 style="color: var(--primary-color); margin-bottom: 0.75rem; font-size: 0.95rem;">üì¶ Upload IntelliJ Project (JAR)</h4>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label for="projectNameInput" style="font-size: 0.85rem; color: var(--text-light);">Project Naam (optioneel)</label>
                            <input type="text" id="projectNameInput" placeholder="Bijv. Report Generator" style="font-size: 0.85rem; padding: 0.5rem;">
                            <small class="hint" style="font-size: 0.75rem;">Laat leeg om de bestandsnaam te gebruiken</small>
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label for="uploadProjectInput" style="font-size: 0.85rem; color: var(--text-light);">Selecteer JAR bestand *</label>
                            <input type="file" id="uploadProjectInput" accept=".jar" style="font-size: 0.85rem; padding: 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(0,212,255,0.3); color: var(--text-color);">
                        </div>
                        <button type="button" id="uploadProjectBtn" class="btn btn-primary" style="width: 100%; padding: 0.65rem; font-size: 0.85rem; background: linear-gradient(135deg, #00d4ff 0%, #00a8cc 100%);">
                            ‚¨ÜÔ∏è Upload Project
                        </button>
                    </div>
                </div>
                
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Wijzigingen Opslaan</button>
                    <button type="button" id="deleteEnvBtn" class="btn btn-danger">Omgeving Verwijderen</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Nieuwe Gebruiker Toevoegen</h2>
            <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                ‚ö†Ô∏è Voor klanten wordt automatisch een ge√Øsoleerde omgeving aangemaakt waar niemand anders toegang toe heeft.
            </p>
            <form id="addUserForm" class="form">
                <div class="form-group">
                    <label for="newEmail">Email (Login Credentials) *</label>
                    <input type="email" id="newEmail" required placeholder="naam@bedrijf.com">
                    <small class="hint">Dit email wordt gebruikt om in te loggen</small>
                </div>
                <div class="form-group">
                    <label for="newPassword">Wachtwoord *</label>
                    <input type="password" id="newPassword" required placeholder="Minimaal 8 karakters">
                    <small class="hint">Zorg voor een sterk wachtwoord</small>
                </div>
                <div class="form-group">
                    <label for="newUsername">Gebruikersnaam *</label>
                    <input type="text" id="newUsername" required placeholder="gebruikersnaam_bedrijf">
                    <small class="hint">Unieke identifier voor deze gebruiker</small>
                </div>
                <div class="form-group">
                    <label for="newCompany">Bedrijfsnaam *</label>
                    <input type="text" id="newCompany" required placeholder="Bedrijf B.V.">
                </div>
                <div class="form-group">
                    <label for="newRole">Rol</label>
                    <select id="newRole">
                        <option value="customer" selected>Customer (Krijgt eigen omgeving)</option>
                        <option value="admin">Admin (Volledige toegang)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newRedirectPath">Redirect Na Login</label>
                    <select id="newRedirectPath">
                        <option value="/dashboard" selected>Customer Dashboard</option>
                        <option value="/admin">Admin Panel</option>
                        <option value="/environment">Environment</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary btn-block">Gebruiker Aanmaken</button>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" id="editUserClose">&times;</span>
            <h2>Edit User</h2>
            <form id="editUserForm" class="form">
                <input type="hidden" id="editUserId">
                
                <div class="form-group">
                    <label for="editUsername">Username</label>
                    <input type="text" id="editUsername" disabled>
                </div>
                <div class="form-group">
                    <label for="editEmail">Email</label>
                    <input type="email" id="editEmail" required>
                </div>
                <div class="form-group">
                    <label for="editCompany">Company</label>
                    <input type="text" id="editCompany" required>
                </div>
                <div class="form-group">
                    <label for="editRole">Role</label>
                    <select id="editRole">
                        <option value="customer">Customer</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editEnvironment">Environment</label>
                    <input type="text" id="editEnvironment" required>
                </div>
                <div class="form-group">
                    <label for="editRedirectPath">Redirect Path After Login</label>
                    <select id="editRedirectPath">
                        <option value="/dashboard">Customer Dashboard</option>
                        <option value="/admin">Admin Panel</option>
                        <option value="/environment">Environment</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editStatus">Status</label>
                    <select id="editStatus">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="suspended">Suspended</option>
                    </select>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" id="deleteUserBtn" class="btn btn-danger">Delete User</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/env.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/admin.js"></script>
    <script>
        // Prevent page load if not authenticated as admin
        console.log('üîê Admin page auth check...');
        const userJson = localStorage.getItem('user');
        if (!userJson) {
            console.warn('‚ùå No user in localStorage, redirecting to login...');
            setTimeout(() => { window.location.href = '/login'; }, 100);
        } else {
            try {
                const user = JSON.parse(userJson);
                console.log('üë§ Found user in localStorage:', user.username, 'Role:', user.role);
                if (user.role !== 'admin') {
                    console.warn('‚ùå User is not admin (' + user.role + '), redirecting to dashboard...');
                    setTimeout(() => { window.location.href = '/dashboard'; }, 100);
                } else {
                    console.log('‚úÖ User is admin, allowing access');
                }
            } catch (e) {
                console.error('‚ùå Error parsing user from localStorage:', e);
                setTimeout(() => { window.location.href = '/login'; }, 100);
            }
        }
    </script>
</body>
</html>
